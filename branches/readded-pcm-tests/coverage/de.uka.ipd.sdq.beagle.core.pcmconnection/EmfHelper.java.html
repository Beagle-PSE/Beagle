<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmfHelper.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Core</a> &gt; <a href="index.source.html" class="el_package">de.uka.ipd.sdq.beagle.core.pcmconnection</a> &gt; <span class="el_source">EmfHelper.java</span></div><h1>EmfHelper.java</h1><pre class="source lang-java linenums">package de.uka.ipd.sdq.beagle.core.pcmconnection;

import de.uka.ipd.sdq.identifier.Identifier;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.eclipse.emf.ecore.xmi.impl.XMIResourceFactoryImpl;
import org.palladiosimulator.pcm.allocation.AllocationPackage;
import org.palladiosimulator.pcm.parameter.ParameterPackage;
import org.palladiosimulator.pcm.repository.RepositoryPackage;
import org.palladiosimulator.pcm.resourceenvironment.ResourceenvironmentPackage;
import org.palladiosimulator.pcm.resourcetype.ResourcetypePackage;
import org.palladiosimulator.pcm.seff.SeffPackage;
import org.palladiosimulator.pcm.system.SystemPackage;
import org.palladiosimulator.pcm.usagemodel.UsagemodelPackage;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;

/**
 * Helper class provided by the SDQ for working with PCM repository files. Also see
 * {@link EcoreUtil} for more helper functions like
 * {@link EcoreUtil#equals(EObject, EObject)} to test for equality.
 *
 * @author Anne Koziolek
 *
 */
public final class EmfHelper {

	/**
	 * Filename length for which storing is tried again. If a filename has at least this
	 * length when trying to store in {@link #saveToXMIFile(EObject, String)} and the
	 * storing fails, weâ€™ll try again once more.
	 */
	private static final int RETRY_FILENAME_LENGTH = 250;

	/**
	 * Private constructor because this is an utility class.
	 */
<span class="nc" id="L49">	private EmfHelper() {</span>
<span class="nc" id="L50">	}</span>

	/**
	 * Checks for two PCM model elements whether they are the same, i.e. whether they have
	 * the same ID. The model elements have to be derived from Identifier. Note that two
	 * systems might use the same assembly contexts and components, but still are two
	 * different systems. If one of the Identifiers in null, false is returned.
	 *
	 * @param identifier1 One Identifier
	 * @param identifier2 Another Identifier
	 * @return true if i1.getId().equals(i2.getId()), false otherwise
	 */
	public static boolean checkIdentity(final EObject identifier1, final EObject identifier2) {
<span class="nc bnc" id="L63" title="All 4 branches missed.">		if (identifier1 == null || identifier2 == null) {</span>
<span class="nc" id="L64">			return false;</span>
		}
<span class="nc bnc" id="L66" title="All 4 branches missed.">		if (identifier1 instanceof Identifier &amp;&amp; identifier2 instanceof Identifier) {</span>
<span class="nc" id="L67">			return ((Identifier) identifier1).getId().equals(((Identifier) identifier2).getId());</span>
		} else {
<span class="nc" id="L69">			return EcoreUtil.equals(identifier1, identifier2);</span>
		}
	}

	/**
	 * Implements an identifier-based contains. Calls
	 * {@link #checkIdentity(EObject, EObject)} to compare the {@link Identifier} i with
	 * the contents of the collection.
	 *
	 * @param coll A collection of objects.
	 * @param identity An identity to search for.
	 * @return true if there is an {@link Identifier} in {@code coll} with an id equal to
	 *         i.getID().
	 */
	public static boolean contains(final Collection&lt;? extends EObject&gt; coll, final EObject identity) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">		for (final EObject identifier : coll) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">			if (checkIdentity(identifier, identity)) {</span>
<span class="nc" id="L86">				return true;</span>
			}
<span class="nc" id="L88">		}</span>
<span class="nc" id="L89">		return false;</span>
	}

	/**
	 * {@link Collection#retainAll(Collection)} for {@link Identifier Identifiers} based
	 * on {@link #checkIdentity(EObject, EObject)}. This method will leave all identifiers
	 * in {@code collection} that describe an object is {@code itemsToRetain}.
	 *
	 * @param collection A collection of identifiers.
	 * @param itemsToRetain The items whose identifiers should be left in
	 *            {@code collection}.
	 * @return {@code true} only if an element was removed from {@code collection}.
	 */
	public static boolean retainAll(final Collection&lt;? extends Identifier&gt; collection,
		final Collection&lt;? extends EObject&gt; itemsToRetain) {
<span class="nc" id="L104">		boolean removedAny = false;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		for (final Iterator&lt;? extends Identifier&gt; iterator = collection.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L106">			final Identifier identifier = iterator.next();</span>
<span class="nc" id="L107">			boolean identifierContainedInItemsToRetain = false;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			for (final EObject identifierToRetain : itemsToRetain) {</span>
<span class="nc" id="L109">				identifierContainedInItemsToRetain |= checkIdentity(identifier, identifierToRetain);</span>
<span class="nc" id="L110">			}</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (!identifierContainedInItemsToRetain) {</span>
<span class="nc" id="L112">				iterator.remove();</span>
<span class="nc" id="L113">				removedAny = true;</span>
			}
<span class="nc" id="L115">		}</span>
<span class="nc" id="L116">		return removedAny;</span>
	}

	/**
	 * Save the given EObject to the file given by filename.
	 *
	 * @param modelToSave The EObject to save
	 * @param fileName The filename where to save.
	 * @throws IOException If accessing the file fails.
	 */
	public static void saveToXMIFile(final EObject modelToSave, final String fileName) throws IOException {
<span class="fc" id="L127">		saveToXMIFile(modelToSave, fileName, true);</span>
<span class="fc" id="L128">	}</span>

	/**
	 * Additional parameter mayRetry to detect to deep recursion.
	 *
	 * @param modelToSave The EObject to save
	 * @param fileName The filename where to save.
	 * @param mayRetry {@code true} saving shall be tried once again if a
	 *            {@link FileNotFoundException} is thrown and {@code fileName} is longer
	 *            as {@link #RETRY_FILENAME_LENGTH}.
	 * @throws IOException If accessing the file fails.
	 */
	private static void saveToXMIFile(final EObject modelToSave, final String fileName, final boolean mayRetry)
		throws IOException {
		// final Logger logger = Logger.getLogger(&quot;de.uka.ipd.sdq.dsexplore&quot;);

		// logger.debug(&quot;Saving &quot; + modelToSave.toString() + &quot; to &quot; + fileName);

		// Create a resource set.
<span class="fc" id="L147">		final ResourceSet resourceSet = new ResourceSetImpl();</span>

		// Register the default resource factory -- only needed for stand-alone!
<span class="fc" id="L150">		resourceSet.getResourceFactoryRegistry()</span>
<span class="fc" id="L151">			.getExtensionToFactoryMap()</span>
<span class="fc" id="L152">			.put(Resource.Factory.Registry.DEFAULT_EXTENSION, new XMIResourceFactoryImpl());</span>

<span class="fc" id="L154">		final URI myURI = URI.createFileURI(fileName);</span>

<span class="fc" id="L156">		final Resource resource = resourceSet.createResource(myURI);</span>
<span class="fc" id="L157">		resource.getContents().add(modelToSave);</span>

		try {
<span class="fc" id="L160">			resource.save(Collections.EMPTY_MAP);</span>
<span class="nc" id="L161">		} catch (final FileNotFoundException fileNotFound) {</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">			if (mayRetry &amp;&amp; fileName.length() &gt; RETRY_FILENAME_LENGTH) {</span>
				// try again with a shorter filename, but just one more try (mayRetry =
				// false).
<span class="nc" id="L165">				saveToXMIFile(modelToSave,</span>
<span class="nc" id="L166">					fileName.substring(0, fileName.indexOf(&quot;-&quot;)) + &quot;-shortened-&quot; + fileName.hashCode(), false);</span>
			} else {
<span class="nc" id="L168">				throw fileNotFound;</span>
			}
<span class="fc" id="L170">		}</span>
<span class="fc" id="L171">	}</span>

	/**
	 * Loads the root object from an EMF File.
	 *
	 * @param fileName Name of the file to load from.
	 * @param ePackage The package to load for.
	 * @return The root element read.
	 */
	public static EObject loadFromXMIFile(final String fileName, final EPackage ePackage) {
		// Create a resource set to hold the resources.
<span class="fc" id="L182">		final ResourceSet resourceSet = new ResourceSetImpl();</span>

		// Register the appropriate resource factory to handle all file
		// extensions.
<span class="fc" id="L186">		resourceSet.getResourceFactoryRegistry()</span>
<span class="fc" id="L187">			.getExtensionToFactoryMap()</span>
<span class="fc" id="L188">			.put(Resource.Factory.Registry.DEFAULT_EXTENSION, new XMIResourceFactoryImpl());</span>

		// Register the package to ensure it is available during loading.
<span class="fc" id="L191">		registerPackages(resourceSet);</span>

<span class="fc" id="L193">		return loadFromXMIFile(fileName, resourceSet, ePackage);</span>
	}

	/**
	 * Loads the root object from an EMF File.
	 *
	 * @param fileName Name of the file to load from.
	 * @param resourceSet The resource set to load.
	 * @param ePackage The package to load for.
	 * @return The root element read.
	 */
	public static EObject loadFromXMIFile(final String fileName, final ResourceSet resourceSet,
		final EPackage ePackage) {
		// Construct the URI for the instance file.
		// The argument is treated as a file path only if it denotes an existing
		// file. Otherwise, it's directly treated as a URL.
<span class="fc" id="L209">		final File file = new File(fileName);</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">		final URI fileUri = file.isFile() ? URI.createFileURI(file.getAbsolutePath()) : URI.createURI(fileName);</span>

<span class="fc" id="L212">		Resource resource = null;</span>
		// Demand load resource for this file.
<span class="fc" id="L214">		resourceSet.getPackageRegistry().put(ePackage.getNsURI(), ePackage);</span>
<span class="fc" id="L215">		resource = resourceSet.getResource(fileUri, true);</span>

<span class="fc" id="L217">		final EObject eObject = resource.getContents().iterator().next();</span>
<span class="fc" id="L218">		return EcoreUtil.getRootContainer(eObject);</span>
	}

	/**
	 * Copied From de.uka.ipd.sdq.pcmsolver.models.PCMInstance.
	 *
	 * @param resourceSet The resource set to register all contained model packages with.
	 */
	private static void registerPackages(final ResourceSet resourceSet) {
<span class="fc" id="L227">		resourceSet.getPackageRegistry().put(AllocationPackage.eNS_URI, AllocationPackage.eINSTANCE);</span>
<span class="fc" id="L228">		resourceSet.getPackageRegistry().put(ParameterPackage.eNS_URI, ParameterPackage.eINSTANCE);</span>
<span class="fc" id="L229">		resourceSet.getPackageRegistry().put(ResourceenvironmentPackage.eNS_URI, ResourceenvironmentPackage.eINSTANCE);</span>
<span class="fc" id="L230">		resourceSet.getPackageRegistry().put(ResourcetypePackage.eNS_URI, ResourcetypePackage.eINSTANCE);</span>
<span class="fc" id="L231">		resourceSet.getPackageRegistry().put(RepositoryPackage.eNS_URI, RepositoryPackage.eINSTANCE);</span>
<span class="fc" id="L232">		resourceSet.getPackageRegistry().put(SeffPackage.eNS_URI, SeffPackage.eINSTANCE);</span>
<span class="fc" id="L233">		resourceSet.getPackageRegistry().put(SystemPackage.eNS_URI, SystemPackage.eINSTANCE);</span>
<span class="fc" id="L234">		resourceSet.getPackageRegistry().put(UsagemodelPackage.eNS_URI, UsagemodelPackage.eINSTANCE);</span>

<span class="fc" id="L236">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>